#!/home/vibanez/anaconda3/envs/mKit/bin/Rscript
suppressPackageStartupMessages({
  library("methylKit")})
args <- commandArgs(trailingOnly = TRUE)
#set paths and chr
path2acc<-"/mnt/disk2/vibanez/03_biseq-processing/03.4_filtering/ac_filter/"
path2results<-"/mnt/disk2/vibanez/04_methylome-comparison/ab_pedigree/"
controlAcc=args[1]
#controlAcc="C6-G0"
#sampleAcc="C9-G0"
#chr2process="SL2.50ch12"
sampleAcc=args[2]
chr2process=args[3]
#
acc<-list.files(path=path2acc, pattern =sampleAcc , full.names = FALSE)
acc<-grep(paste0(chr2process, ".filtered.bed"), acc, value = TRUE)

ref2compare<-list.files(path= path2acc, pattern=controlAcc, full.names = FALSE)
ref2compare<-grep(paste0(chr2process, ".filtered.bed"), ref2compare, value = TRUE)

allacc<-c(ref2compare, acc)
allacc<-paste0(path2acc, allacc)
allacc

allSamples<-grep("CG",allacc, value = TRUE)
allSamples<-gsub(path2acc, "", allSamples)
sampleNames<-as.list(c(allSamples)) #Definir el nombre de las muestras para methylkit
ctrlContrast<-c(0)
sampleContrast<-c(1)
contr<-c(ctrlContrast, sampleContrast) #Definir los contrastas del diseÃ±o exp
refGen<-"SL2.50" #Nombre del genoma de Referencia

CGdata<-list()
CHGdata<-list()
CHHdata<-list()
inFileCG<-grep("CG", c(allacc), value=TRUE)
inFileCHG<-grep("CHG", c(allacc), value=TRUE)
inFileCHH<-grep("CHH", c(allacc), value=TRUE)

for (i in 1:length(inFileCG)){
  CGdata[[i]] <- inFileCG[i]
  CHGdata[[i]] <- inFileCHG[i]
  CHHdata[[i]] <- inFileCHH[i]
}

#start with methylkit
cat(paste0("----- Loading data to mKit", "\n"))
cat(paste0("---------- CG", "\n"))
CG.cov<-methRead(CGdata, context = "CpG", sample.id =sampleNames,
                 treatment =contr, assembly= refGen , pipeline = "bismarkCytosineReport",
                 mincov = 0, header = FALSE)
cat(paste0("---------- CHG", "\n"))
CHG.cov<-methRead(CHGdata, context = "CHG", sample.id =sampleNames,
                  treatment =contr, assembly= refGen , pipeline = "bismarkCytosineReport",
                  mincov = 0, header = FALSE)
cat(paste0("---------- CHH", "\n"))
CHH.cov<-methRead(CHHdata, context = "CHH", sample.id =sampleNames,
                  treatment =contr, assembly= refGen , pipeline = "bismarkCytosineReport",
                  mincov = 0, header = FALSE)

cat(paste0("----- Filtering high coverage", "\n"))
cat(paste0("---------- CG", "\n"))
CG.filtered=filterByCoverage(CG.cov,lo.count=3,lo.perc=NULL,
                             hi.count=NULL,hi.perc=99.9, chunk.size = 1e+10)
cat(paste0("---------- CHG", "\n"))
CHG.filtered=filterByCoverage(CHG.cov,lo.count=3,lo.perc=NULL,
                              hi.count=NULL,hi.perc=99.9, chunk.size = 1e+16)
cat(paste0("---------- CHH", "\n"))
CHH.filtered=filterByCoverage(CHH.cov,lo.count=3,lo.perc=NULL,
                              hi.count=NULL,hi.perc=99.9, chunk.size = 1e+20)

cat(paste0("----- Merging data", "\n"))
cat(paste0("---------- CG", "\n"))
CG.norm<-unite(CG.filtered, destrand = FALSE, min.per.group = 1L)
cat(paste0("---------- CHG", "\n"))
CHG.norm<-unite(CHG.filtered, destrand = FALSE, min.per.group = 1L)
cat(paste0("---------- CHH", "\n"))
CHH.norm<-unite(CHH.filtered, destrand = FALSE, min.per.group = 1L)

cat(paste0("----- Creating windows", "\n"))
cat(paste0("---------- CG", "\n"))
CG.wind <- tileMethylCounts(CG.norm, win.size = 100, step.size = 100, mc.cores = 50)
cat(paste0("---------- CHG", "\n"))
CHG.wind <-tileMethylCounts(CHG.norm, win.size = 100, step.size = 100, mc.cores= 50)
cat(paste0("---------- CHH", "\n"))
CHH.wind <- tileMethylCounts(CHH.norm, win.size = 100, step.size = 100, mc.cores = 50)

cat(paste0("----- Calculating DMR", "\n"))
cat(paste0("---------- CG", "\n"))
CG.DMR <- data.frame(calculateDiffMeth(CG.wind, mc.cores= 20))
cat(paste0("---------- CHG", "\n"))
CHG.DMR <- data.frame(calculateDiffMeth(CHG.wind, mc.cores= 20))
cat(paste0("---------- CHH", "\n"))
CHH.DMR <- data.frame(calculateDiffMeth(CHH.wind, mc.cores = 28))

cat(paste0("----- Filtering by qvalue and methylation difference", "\n"))
cat(paste0("---------- CG", "\n"))
CG.dfDMR<-data.frame(CG.wind)
context<-rep("CG", times=nrow(CG.dfDMR))

#toName<-c('chr', 'start', 'end', 'strand', cnames)
#colnames(CG.dfDMR)<-toName
CG_DMR<-cbind.data.frame(CG.dfDMR, context, CG.DMR[,c('pvalue', 'qvalue', 'meth.diff')])
#CG_DMR.toSave<-subset(CG_DMR, qvalue<=0.05 & (meth.diff <= -50 | meth.diff >= 50))
CG_DMR.toSave<-CG_DMR
chr2save<-gsub('SL2.50','', chr2process)
data.table::fwrite(CG_DMR.toSave, file=paste0(path2results, chr2save,"_" ,controlAcc,"_",sampleAcc,"_CG_DMR.methylation.bed"),
                   quote=F,row.names=F,col.names = F,sep="\t", nThread=20, buffMB=1024)

cat(paste0("---------- CHG", "\n"))
CHG.dfDMR<-data.frame(CHG.wind)
context<-rep("CHG", times=nrow(CHG.dfDMR))
#toName<-c('chr', 'start', 'end', 'strand', cnames)
#colnames(CHG.dfDMR)<-toName
CHG_DMR<-cbind.data.frame(CHG.dfDMR, context, CHG.DMR[,c('pvalue', 'qvalue', 'meth.diff')])
#CHG_DMR.toSave<-subset(CHG_DMR, qvalue<=0.05 & (meth.diff <= -50 | meth.diff >= 50))
CHG_DMR.toSave<-CHG_DMR
data.table::fwrite(CHG_DMR.toSave, file=paste0(path2results, chr2save,"_",controlAcc,"_",sampleAcc,"_CHG_DMR.methylation.bed"),
                   quote=F,row.names=F,col.names = F,sep="\t", nThread=20, buffMB=1024)

cat(paste0("---------- CHH", "\n"))
CHH.dfDMR<-data.frame(CHH.wind)
context<-rep("CHH", times=nrow(CHH.dfDMR))
#toName<-c('chr', 'start', 'end', 'strand', cnames)
#colnames(CHH.dfDMR)<-toName
CHH_DMR<-cbind.data.frame(CHH.dfDMR, context, CHH.DMR[,c('pvalue', 'qvalue', 'meth.diff')])
#CHH_DMR.toSave<-subset(CHH_DMR, qvalue<=0.05 & (meth.diff <= -10 | meth.diff >= 10))
CHH_DMR.toSave<-CHH_DMR
data.table::fwrite(CHH_DMR.toSave, file=paste0(path2results, chr2save,"_",controlAcc,"_",sampleAcc,"_CHH_DMR.methylation.bed"),
                   quote=F,row.names=F,col.names = F,sep="\t", nThread=20, buffMB=1024)

CHH_DMR.toSave<-CHH_DMR
data.table::fwrite(CHH_DMR.toSave, file=paste0(path2results, chr2save,"_",controlAcc,"_",sampleAcc,"_CHH_DMR.methylation.bed"),
                   quote=F,row.names=F,col.names = F,sep="\t", nThread=20, buffMB=1024)
